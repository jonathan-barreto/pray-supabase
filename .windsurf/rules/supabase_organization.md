---
trigger: always_on
---

# Regras e Melhores Práticas para Supabase - Parte 2: Organização

## Índice

1. [Organização](#organização)
   - [Estrutura do Banco de Dados](#estrutura-do-banco-de-dados)
   - [Organização de Código](#organização-de-código)
   - [Migrations e Versionamento](#migrations-e-versionamento)
   - [Documentação](#documentação)
   - [Gerenciamento de Ambientes](#gerenciamento-de-ambientes)

## Organização

Uma estrutura bem organizada é fundamental para a manutenção e escalabilidade de projetos baseados em Supabase. Esta seção apresenta diretrizes e melhores práticas para organizar seu banco de dados, código e recursos de forma eficiente.

### Estrutura do Banco de Dados

#### Esquemas

1. **Use Esquemas para Separar Contextos**
   ```sql
   -- Esquema para autenticação e usuários
   CREATE SCHEMA auth;
   
   -- Esquema para lógica de negócios principal
   CREATE SCHEMA app;
   
   -- Esquema para recursos de auditoria
   CREATE SCHEMA audit;
   ```

2. **Esquemas Recomendados**
   - `public`: Tabelas principais acessíveis ao cliente
   - `auth`: Extensões e tabelas relacionadas à autenticação
   - `storage`: Recursos relacionados ao armazenamento
   - `audit`: Logs e registros de auditoria
   - `utils`: Funções utilitárias

3. **Controle de Acesso por Esquema**
   ```sql
   -- Revoga acesso público ao esquema de auditoria
   REVOKE ALL ON SCHEMA audit FROM PUBLIC;
   
   -- Concede acesso apenas para roles específicas
   GRANT USAGE ON SCHEMA audit TO admin_role;
   ```

#### Nomenclatura de Tabelas

1. **Convenções de Nomenclatura**
   - Use substantivos no plural para tabelas: `users`, `products`, `orders`
   - Use snake_case para todos os identificadores
   - Seja consistente e descritivo

2. **Prefixos e Sufixos Significativos**
   - Tabelas de junção: `user_achievements` (relaciona users e achievements)
   - Tabelas de log: `audit_logs`, `change_history`
   - Tabelas temporárias: `tmp_import_data`

3. **Exemplos de Nomenclatura**
   ```sql
   -- Tabela principal
   CREATE TABLE users (id BIGINT PRIMARY KEY, ...);
   
   -- Tabela de métricas (relacionada)
   CREATE TABLE user_metrics (user_id BIGINT PRIMARY KEY, ...);
   
   -- Tabela de junção
   CREATE TABLE user_achievements (user_id BIGINT, achievement_id BIGINT, ...);
   ```

#### Campos e Tipos de Dados

1. **Convenções para Campos**
   - IDs: `id` para chave primária da própria tabela
   - Chaves estrangeiras: `table_name_id` (ex: `user_id`)
   - Timestamps: `created_at`, `updated_at`, `deleted_at`

2. **Tipos de Dados Apropriados**
   - Use `uuid` para IDs públicos expostos em APIs
   - Use `bigint` para IDs internos e sequenciais
   - Use `timestamptz` (não `timestamp`) para armazenar datas com fuso horário
   - Use `text` em vez de `varchar` na maioria dos casos
   - Use tipos específicos: `jsonb` para JSON, `interval` para durações

3. **Valores Padrão e Restrições**
   ```sql
   CREATE TABLE users (
     id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
     email TEXT NOT NULL UNIQUE,
     created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
     updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
     status TEXT NOT NULL CHECK (status IN ('active', 'inactive', 'suspended'))
   );
   ```

### Organização de Código

#### Edge Functions

1. **Estrutura de Diretórios**
   ```
   /supabase
     /functions
       /user
         /source
           index.ts
       /user-metrics
         /source
           index.ts
       /shared
         /utils
           validation.ts
           responses.ts
   ```

2. **Modularização**
   - Separe lógica de negócios, validação e formatação de resposta
   - Crie módulos compartilhados para código reutilizável
   - Mantenha cada função focada em uma única responsabilidade

3. **Convenções de Nomenclatura**
   - Use kebab-case para nomes de funções: `user-metrics`, `lesson-complete`
   - Use camelCase para variáveis e funções em TypeScript
   - Use PascalCase para interfaces e tipos: `interface UserMetrics`

#### Padrões de Código

1. **Estrutura Consistente para Edge Functions**
   ```typescript
   // 1. Importações
   import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
   import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
   
   // 2. Tipos e interfaces
   interface RequestBody {
     user_id: number;
     // ...
   }
   
   // 3. Funções auxiliares
   function validateInput(body: any): boolean {
     // ...
   }
   
   // 4. Handler principal
   serve(async (req) => {
     // 4.1. Validação de método
     if (req.method !== 'POST') {
       return new Response(JSON.stringify({
         success: false,
         message: 'Method Not Allowed'
       }), { status: 405, headers: { 'Content-Type': 'application/json' } });
     }
     
     // 4.2. Autenticação
     // ...
     
     // 4.3. Processamento
     // ...
     
     // 4.4. Resposta
     return new Response(JSON.stringify({
       success: true,
       data: result
     }), { status: 200, headers: { 'Content-Type': 'application/json' } });
   });
   ```

2. **Tratamento de Erros Padronizado**
   ```typescript
   try {
     // Lógica principal
   } catch (error) {
     console.error(`Error in function: ${error.message}`);
     return new Response(JSON.stringify({
       success: false,
       message: 'Internal Server Error',
       error: process.env.NODE_ENV === 'development' ? error.message : undefined
     }), { status: 500, headers: { 'Content-Type': 'application/json' } });
   }
   ```

3. **Validação de Entrada Consistente**
   ```typescript
   function validateUserInput(body: any): { valid: boolean; errors?: string[] } {
     const errors = [];
     
     if (!body.user_id || typeof body.user_id !== 'number') {
       errors.push('Invalid or missing user_id');
     }
     
     // Mais validações...
     
     return {
       valid: errors.length === 0,
       errors: errors.length > 0 ? errors : undefined
     };
   }
   ```

### Migrations e Versionamento

1. **Use Migrations para Todas as Alterações**
   ```sql
   -- 20250901120000_create_users_table.sql
   CREATE TABLE users (
     id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
     email TEXT NOT NULL UNIQUE,
     created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
     updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
   );
   ```

2. **Convenção de Nomenclatura para Migrations**
   - Formato: `YYYYMMDDHHMMSS_descricao_curta.sql`
   - Exemplo: `20250901120000_create_users_table.sql`

3. **Migrations Idempotentes**
   ```sql
   -- Verifica se a tabela já existe antes de criar
   DO $$
   BEGIN
     IF NOT EXISTS (
       SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'users'
     ) THEN
       CREATE TABLE users (
         -- definição da tabela
       );
     END IF;
   END
   $$;
   ```

4. **Documentação em Migrations**
   ```sql
   /*
   * Migration: Create Users Table
   * Description: Cria a tabela principal de usuários com campos básicos
   * Author: João Silva
   * Date: 2025-09-01
   */
   
   -- Criação da tabela
   CREATE TABLE users (
     -- definição da tabela
   );
   
   -- Comentários para documentação
   COMMENT ON TABLE users IS 'Armazena informações básicas dos usuários';
   COMMENT ON COLUMN users.email IS 'Email único do usuário, usado para login';
   ```

### Documentação

1. **Comentários em Objetos do Banco de Dados**
   ```sql
   -- Comentários em tabelas
   COMMENT ON TABLE users IS 'Armazena informações básicas dos usuários';
   
   -- Comentários em colunas
   COMMENT ON COLUMN users.email IS 'Email único do usuário, usado para login';
   
   -- Comentários em funções
   COMMENT ON FUNCTION calculate_metrics IS 'Calcula métricas de usuário com base em atividades';
   ```

2. **README para Cada Componente**
   - Crie um README.md para cada diretório principal
   - Documente propósito, estrutura e exemplos de uso

3. **Documentação de API**
   - Documente todos os endpoints com exemplos de requisição e resposta
   - Inclua informações sobre autenticação, parâmetros e códigos de erro

### Gerenciamento de Ambientes

1. **Separação Clara de Ambientes**
   - Desenvolvimento: Para trabalho local e testes iniciais
   - Staging: Para testes integrados e QA
   - Produção: Para usuários finais

2. **Variáveis de Ambiente por Ambiente**
   ```
   # .env.development
   SUPABASE_URL=https://dev-project.supabase.co
   SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1...
   
   # .env.production
   SUPABASE_URL=https://prod-project.supabase.co
   SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1...
   ```

3. **Branches para Desenvolvimento**
   - Use branches do Supabase para desenvolvimento e testes
   - Faça merge para produção apenas após testes completos
